---
title: "Composition analysis of nAChR genes in _Bombus terrestris_ using `DESeq2`"
author: "Federico Lopez"
date: '`r Sys.Date()`'
output:
  github_document:
    toc: yes
  pdf_document: 
    fig_caption: yes
    toc: yes
  html_document:
    toc: yes
editor_options: 
  chunk_output_type: console
geometry: margin = 1cm
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache.lazy = FALSE,
  include = FALSE,
  out.height = "\textheight",
  out.width = "\textwidth"
)
```

# Set up the project directory to use `renv`
```{r}
renv::init(
  project = "~/projects/2020_bombus_nachrs", bare = TRUE,
  restart = FALSE
)
renv::snapshot()
```

# Load libraries and input data
Load required libraries.
```{r}
# Check if packages are installed and install new packages
# if necessary, then load packages
load_cran_pkgs <- function(pkg) {
  new_pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new_pkg)) {
    install.packages(new_pkg, dependencies = TRUE)
  }
  sapply(pkg, require, character.only = TRUE)
}

# Load CRAN packages
cran_pkgs <- c(
  "BiocManager", "tidyverse", "ggfortify", "RColorBrewer", "wesanderson", 
  "pheatmap", "renv", "styler"
)
load_cran_pkgs(cran_pkgs)

# Load Bioconductor packages
load_bioconductor_pkgs <- function(pkg) {
  new_pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new_pkg)) {
    BiocManager::install(new_pkg, version = "3.10")
  }
  sapply(pkg, require, character.only = TRUE)
}

bioconductor_pkgs <- c(
  "biomaRt", "rhdf5", "tximport", "DESeq2"
)
load_bioconductor_pkgs(bioconductor_pkgs)

# Set a custom ggplot theme
# If "Error: (converted from warning)...":
# Sys.setenv(R_REMOTES_NO_ERRORS_FROM_WARNINGS = "true")
# devtools::install_github("cttobin/ggthemr")
library(ggthemr)
# Use colorblind-friendly palette
# http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#a-colorblind-friendly-palette
cbp1 <- c(
  "#6A6A6A", "#E69F00", "#56B4E9", "#009E73",
  "#F0E442", "#0072B2", "#D55E00", "#CC79A7"
)

# ggthemr::colour_plot(cbp1)

custom_theme <- ggthemr::define_palette(
  swatch = cbp1,
  gradient = c(lower = "#6A6A6A", upper = "#56B4E9")
)
ggthemr::ggthemr(custom_theme)
# ggthemr::ggthemr_reset()
```

Set the base directory including `kallisto` results and read
table of samples and covariates.
```{r}
# Set directory that contains the active file as the working directory
# setwd(getSrcDirectory()[1]) # Use outside of RStudio
# Comment out before knitting in RStudio
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
base_dir <- getwd()

# Create directory for results
dir.create("results/colgan", recursive = TRUE)
# dir.create("results/colgan/plots", recursive = TRUE)

# Set sample identifiers using the names of the kallisto output directories
sample_ids <- dir(file.path(
  base_dir,
  "2019_colgan_queen-worker_head/2020-05-06-kallisto"
))

# Read metadata table
samples_table <- read.csv(
  file.path(
    base_dir, "2019_colgan_queen-worker_head",
    "2019_colgan_queen-worker_head_metadata.csv"
  ),
  header = TRUE,
  stringsAsFactors = TRUE
)

colnames(samples_table)

samples_table$caste <- relevel(
  samples_table$caste,
  ref = "queen"
)

input_files <- file.path(
  base_dir,
  "2019_colgan_queen-worker_head/2020-05-06-kallisto",
  samples_table$sample,
  "abundance.h5"
)

names(input_files) <- samples_table$sample
input_files

# Check that all files exist
all(file.exists(input_files))
# input_files
```

# Associate transcripts to genes
```{r}
# Remove all biomaRt cached files
# biomaRt::biomartCacheInfo()
# biomaRt::biomartCacheClear()

# Retrieve Ensembl gene identifiers/names and create transcript-to-gene table
biomaRt::listMarts(host = "metazoa.ensembl.org")
# biomaRt::listMarts(host = "eg40-metazoa.ensembl.org") # version 40
# biomaRt::listEnsemblArchives()

metazoa_mart <- biomaRt::useMart(
  biomart = "metazoa_mart",
  dataset = "bterrestris_eg_gene",
  host = "metazoa.ensembl.org" # version 47
)

transcript_to_gene <- biomaRt::getBM(
  attributes = c("ensembl_transcript_id", "ensembl_gene_id"),
  mart = metazoa_mart
)

# biomaRt::listAttributes(metazoa_mart)
```

# Import `kallisto` quantifications using `tximport`
```{r}
txi <- tximport::tximport(input_files,
  type = "kallisto",
  tx2gene = transcript_to_gene,
  txOut = FALSE
)
```

# Analysis of nAChR proportions 
## Fit glm with normalized nAChR TPM values as the response variable
```{r}
nachrs <- c(
  "LOC100643274", "LOC100643282", "LOC100645032", "LOC100646787",
  "LOC100647301", "LOC100647350", "LOC100647624", "LOC100648987",
  "LOC100649515", "LOC100649612", "LOC100649796"
)

# Divide the TPM value of each nAChR subunit by the sum of all nAChR subunit
# TPM values in a sample
nachrs_ntpms <- txi$abundance %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "ens_gene") %>%
  tidyr::gather(key = "sample", value = "tpm", -ens_gene) %>%
  dplyr::mutate_if(is.numeric, round, digits = 4) %>%
  dplyr::filter(ens_gene %in% nachrs) %>%
  dplyr::group_by(sample) %>%
  dplyr::mutate(norm_tpm = tpm / sum(tpm)) %>%
  dplyr::mutate(caste = case_when(
    grepl("worker", sample) ~ "worker",
    grepl("queen", sample) ~ "queen"
  ))

head(nachrs_ntpms)

# Plot distribution of normalized TPM values in each caste
ggplot(nachrs_ntpms, aes(x = norm_tpm, fill = caste, color = caste)) +
  geom_density(alpha = 0.5) +
  labs(
    x = "Normalized TPM (divided by sum of nAChR TPM values per sample)",
    y = "Density"
  )

# Compute descriptive parameters of an empirical distribution
# fitdistrplus::descdist(nachrs_ntpms$norm_tpm, discrete = FALSE, boot = 1000)
# flogis <- fitdistrplus::fitdist(nachrs_ntpms$norm_tpm,
#   distr = "logis"
# )
# summary(flogis)
# AIC:  -172.8365
# plot(flogis)
# 
# fbeta <- fitdistrplus::fitdist(nachrs_ntpms$norm_tpm,
#   distr = "beta"
# )
# summary(fbeta)
# AIC:  -242.2882
# plot(fbeta)

# Fit glm
glmfit <- glm(
  formula = norm_tpm ~ ens_gene + caste + ens_gene * caste,
  family = quasibinomial(link = "logit"), data = nachrs_ntpms
)
summary(glmfit)

# Turn glm results into a tidy tibble
broom::tidy(glmfit)

# Look at the diagnostics
broom::glance(glmfit)

# Return a tibble with information about data points
broom::augment(glmfit)

autoplot(glmfit,
  which = 1:4, ncol = 2, label.size = 3,
  colour = "caste", data = nachrs_ntpms
) +
  theme(
    plot.title = element_text(hjust = 0.5, size = 12, face = "plain"),
    plot.subtitle = element_text(hjust = 0.5, size = 12, face = "plain"),
    strip.text = element_text(size = 12, face = "plain", hjust = 0.5),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 10),
    # axis.text.x = element_text(size = 10, angle = 90, hjust = 1),
  ) # + theme_bw()

# Sample "36" appears as an outlier in "Cook's distance plot"
nachrs_ntpms[34:38, ]
# 36: LOC100645032 C61_worker_head
nachrs_ntpms %>%
  dplyr::filter(ens_gene == "LOC100645032")

# Computation of the R^2 with a function
# r2glm <- function(model) {
#   summaryLog <- summary(model)
#   1 - summaryLog$deviance / summaryLog$null.deviance
# }
# 
# r2glm(glmfit)
```
