---
title: "Prepare data frames for plotting Figure 1"
author: "Federico Lopez, Alicja Witwicka"
date: '`r Sys.Date()`'
output:
  pdf_document: 
    fig_caption: yes
    toc: yes
  github_document:
    toc: yes
  html_document:
    toc: yes
editor_options: 
  chunk_output_type: console
geometry: margin = 1cm
---

```{r setup, echo = FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache.lazy = TRUE,
  include = TRUE,
  out.height = "\textheight",
  out.width = "\textwidth"
)
```

# Load libraries
```{r}
load_pkgs <- function(pkg) {
  sapply(pkg, require, character.only = TRUE)
}

cran_pkgs <- c(
  "BiocManager", "tidyverse", "patchwork", "ggtext", "styler", "here"
)
load_pkgs(cran_pkgs)

bioconductor_pkgs <- c(
  "biomaRt", "rhdf5", "tximport", "DESeq2"
)
load_pkgs(bioconductor_pkgs)
```

# Set a custom ggplot theme
```{r}
# Set a custom ggplot theme
# devtools::install_github("cttobin/ggthemr")
library(ggthemr)
# Diverging
custom_palette <- c(
  "#9E9E9E", "#59BDEF", "#EBCC2A", "#E1AF00", "#F27C8D", "#7B73D1", "#7B9FE0",
  "#F5CC7F", "#66C2A5", "#28A7B6", "#F2CB57", "#F2A057", "#F2845C"
)
# ggthemr::colour_plot(custom_palette)

custom_theme <- ggthemr::define_palette(
  swatch = custom_palette,
  gradient = c(lower = "#59BDEF", upper = "#FF6B5A")
)
ggthemr::ggthemr(custom_theme)
```

# Create directory for results
```{r}
# here::here()
# Create directory for results
dir.create(here::here("results", "2020-07-28-gene_expression"),
  recursive = TRUE
)
```

# Read tables of samples and covariates
## _Apis mellifera_
```{r}
# Jasper et al. 2015
# Set sample identifiers using the names of the kallisto output directories
jasper_ids <- dir(here::here(
  "2015-jasper_worker_tissues", "2020-06-16-kallisto", "results"
))

# Read metadata table
jasper_table <- read.csv(
  here::here(
    "amel_metadata",
    "2015-jasper_worker_tissues_metadata.csv"
  ),
  header = TRUE,
  stringsAsFactors = TRUE
)

jasper_files <- here::here(
  "2015-jasper_worker_tissues", "2020-06-16-kallisto", "results",
  jasper_table$sample,
  "abundance.h5"
)

names(jasper_files) <- jasper_table$sample

# Check that sample names match
all(jasper_ids %in% jasper_table$sample)

# Check that all files exist
all(file.exists(jasper_files))

# Manfredini et al. 2015
# Set sample identifiers using the names of the kallisto output directories
amel_manfredini_ids <- dir(here::here(
  "2015-manfredini_queen_brains", "2020-06-18-kallisto", "results"
))

# Read metadata table
amel_manfredini_table <- read.csv(
  here::here(
    "amel_metadata",
    "2015-manfredini_queen_brains_metadata.csv"
  ),
  header = TRUE,
  stringsAsFactors = TRUE
)

amel_manfredini_files <- here::here(
  "2015-manfredini_queen_brains", "2020-06-18-kallisto", "results",
  amel_manfredini_table$sample,
  "abundance.h5"
)

names(amel_manfredini_files) <- amel_manfredini_table$sample

# Check that sample names match
all(amel_manfredini_ids %in% amel_manfredini_table$sample)

# Check that all files exist
all(file.exists(amel_manfredini_files))

# Liberti et al. 2015
# Set sample identifiers using the names of the kallisto output directories
liberti_ids <- dir(here::here(
  "2015-liberti_queen_brains", "2020-06-18-kallisto", "results"
))

# Read metadata table
liberti_table <- read.csv(
  here::here(
    "amel_metadata",
    "2015-liberti_queen_brains_metadata.csv"
  ),
  header = TRUE,
  stringsAsFactors = TRUE
)

liberti_files <- here::here(
  "2015-liberti_queen_brains", "2020-06-18-kallisto", "results",
  liberti_table$sample,
  "abundance.h5"
)

names(liberti_files) <- liberti_table$sample

# Check that sample names match
all(liberti_ids %in% liberti_table$sample)

# Check that all files exist
all(file.exists(liberti_files))

# Christen et al. 2015
# Set sample identifiers using the names of the kallisto output directories
christen_ids <- dir(here::here(
  "2018-christen_worker_brains", "2020-06-18-kallisto", "results"
))

# Read metadata table
christen_table <- read.csv(
  here::here(
    "amel_metadata",
    "2018-christen_worker_brains_metadata.csv"
  ),
  header = TRUE,
  stringsAsFactors = TRUE
)

christen_files <- here::here(
  "2018-christen_worker_brains", "2020-06-18-kallisto", "results",
  christen_table$sample,
  "abundance.h5"
)

names(christen_files) <- christen_table$sample

# Check that sample names match
all(christen_ids %in% christen_table$sample)

# Check that all files exist
all(file.exists(christen_files))
```

## _Bombus terrestris_
```{r}
# Colgan et al. 2019
# Set sample identifiers using the names of the kallisto output directories
colgan_ids <- dir(here::here(
  "2019-colgan_queen_worker_head", "2020-07-14-kallisto", "results"
))

# Read metadata table
colgan_table <- read.csv(
  here::here(
    "bter_metadata",
    "2019-colgan_queen_worker_head_metadata.csv"
  ),
  header = TRUE,
  stringsAsFactors = TRUE
)

colgan_files <- here::here(
  "2019-colgan_queen_worker_head", "2020-07-14-kallisto", "results",
  colgan_table$sample,
  "abundance.h5"
)

names(colgan_files) <- colgan_table$sample

# Check that sample names match
all(colgan_ids %in% colgan_table$sample)

# Check that all files exist
all(file.exists(colgan_files))

# Harrison et al. 2015
# Set sample identifiers using the names of the kallisto output directories
harrison_ids <- dir(here::here(
  "2015-harrison_queen_worker_whole_body",
  "2020-07-14-kallisto", "results"
))

# Read metadata table
harrison_table <- read.csv(
  here::here(
    "bter_metadata",
    "2015-harrison_queen_worker_whole_body_metadata.csv"
  ),
  header = TRUE,
  stringsAsFactors = TRUE
)

harrison_files <- here::here(
  "2015-harrison_queen_worker_whole_body",
  "2020-07-14-kallisto", "results",
  harrison_table$sample,
  "abundance.h5"
)

names(harrison_files) <- harrison_table$sample

# Check that sample names match
all(harrison_ids %in% harrison_table$sample)

# Check that all files exist
all(file.exists(harrison_files))
```

# Combine input files and information about the samples
```{r}
# Apis mellifera
amel_files <- c(
  jasper_files, amel_manfredini_files, liberti_files, christen_files
)
amel_table <- dplyr::bind_rows(
  jasper_table, amel_manfredini_table, liberti_table, christen_table
) %>%
  dplyr::select(sample, caste, tissue, study, species)

# Bombus terrestris
bter_files <- c(colgan_files, harrison_files)
bter_table <- dplyr::bind_rows(colgan_table, harrison_table) %>%
  dplyr::select(sample, caste, tissue, stage, study, species)
```

# Associate transcripts to genes
```{r}
# Remove all biomaRt cached files
# biomaRt::biomartCacheInfo()
# biomaRt::biomartCacheClear()

# Retrieve Ensembl gene identifiers/names and create transcript-to-gene table
biomaRt::listMarts(host = "metazoa.ensembl.org")
# biomaRt::listMarts(host = "eg40-metazoa.ensembl.org") # version 40
# biomaRt::listEnsemblArchives()

# Apis mellifera
amel_mart <- biomaRt::useMart(
  biomart = "metazoa_mart",
  dataset = "amellifera_eg_gene",
  host = "metazoa.ensembl.org" # version 47
)

amel_tx2gene <- biomaRt::getBM(
  attributes = c("ensembl_transcript_id", "ensembl_gene_id"),
  mart = amel_mart
)

# Bombus terrestris
bter_mart <- biomaRt::useMart(
  biomart = "metazoa_mart",
  dataset = "bterrestris_eg_gene",
  host = "metazoa.ensembl.org" # version 47
)

bter_tx2gene <- biomaRt::getBM(
  attributes = c("ensembl_transcript_id", "ensembl_gene_id"),
  mart = bter_mart
)
```

# Import `kallisto` quantifications using `tximport`
```{r}
# Apis mellifera
amel_txi <- tximport::tximport(amel_files,
  type = "kallisto",
  tx2gene = amel_tx2gene,
  txOut = FALSE
)

# Bombus terrestris
bter_txi <- tximport::tximport(bter_files,
  type = "kallisto",
  tx2gene = bter_tx2gene,
  txOut = FALSE
)
```

# Create `DESeqDataSet` objects
```{r}
# Apis mellifera
amel_dds <- DESeq2::DESeqDataSetFromTximport(amel_txi,
  colData = amel_table,
  design = ~ caste + tissue
)

# Estimate the size factors
amel_dds <- DESeq2::estimateSizeFactors(amel_dds)
# Filtering
keep <- rowSums(DESeq2::counts(amel_dds) >= 10) >= 3
dds <- amel_dds[keep, ]

# Bombus terrestris
bter_dds <- DESeq2::DESeqDataSetFromTximport(bter_txi,
  colData = bter_table,
  design = ~ caste + tissue + stage
)

# Estimate the size factors
bter_dds <- DESeq2::estimateSizeFactors(bter_dds)
# Filtering
keep <- rowSums(DESeq2::counts(bter_dds) >= 10) >= 3
dds <- bter_dds[keep, ]
```

# Normalise the counts using `DESeq2`'s median-of-ratios method
```{r}
amel_counts <- DESeq2::counts(amel_dds, normalized = TRUE)
bter_counts <- DESeq2::counts(bter_dds, normalized = TRUE)
```

# Create data frames of normalised counts 
## Apis mellifera
```{r}
amel_nachrs <- c(
  "GB42850", "GB42644", "GB47845", "GB43275", "GB43064", "GB43416",
  "GB53053", "GB40923", "GB53427", "GB53055", "GB53428"
)

amel_counts_nachrs <- amel_counts %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "ens_gene") %>%
  tidyr::gather(key = "sample", value = "norm_count", -ens_gene) %>%
  dplyr::mutate_if(is.numeric, round, digits = 4) %>%
  dplyr::filter(ens_gene %in% amel_nachrs) %>%
  dplyr::mutate(subunit = case_when(
    ens_gene == "GB42850" ~ "alpha1",
    ens_gene == "GB42644" ~ "alpha2",
    ens_gene == "GB47845" ~ "alpha3",
    ens_gene == "GB43275" ~ "alpha4",
    ens_gene == "GB43064" ~ "alpha5",
    ens_gene == "GB43416" ~ "alpha6",
    ens_gene == "GB53053" ~ "alpha7",
    ens_gene == "GB40923" ~ "alpha8",
    ens_gene == "GB53427" ~ "alpha9",
    ens_gene == "GB53055" ~ "beta1",
    ens_gene == "GB53428" ~ "beta2"
  )) %>%
  dplyr::mutate(study = case_when(
    stringr::str_detect(
      sample, paste(jasper_table$sample, collapse = "|")
    ) ~ "jasper",
    stringr::str_detect(
      sample, paste(amel_manfredini_table$sample, collapse = "|")
    ) ~ "manfredini",
    stringr::str_detect(
      sample, paste(liberti_table$sample, collapse = "|")
    ) ~ "liberti",
    stringr::str_detect(
      sample, paste(christen_table$sample, collapse = "|")
    ) ~ "christen"
  )) %>%
  dplyr::mutate(tissue = case_when(
    grepl("brain", sample) ~ "brain",
    grepl("antenna", sample) ~ "antenna",
    grepl("midgut", sample) ~ "midgut",
    grepl("hypopharyngeal_gland", sample) ~ "hypopharyngeal_gland",
    grepl("malpighian_tubule", sample) ~ "malpighian_tubule",
    grepl("mandibular_gland", sample) ~ "mandibular_gland",
    grepl("muscle", sample) ~ "muscle",
    grepl("nasonov_gland", sample) ~ "nasonov_gland",
    grepl("thoracic_ganglion", sample) ~ "thoracic_ganglion",
    stringr::str_detect(
      sample, paste(amel_manfredini_table$sample, collapse = "|")
    ) ~ "brain",
    stringr::str_detect(
      sample, paste(liberti_table$sample, collapse = "|")
    ) ~ "brain",
    stringr::str_detect(
      sample, paste(christen_table$sample, collapse = "|")
    ) ~ "brain"
  )) %>%
  dplyr::mutate(caste = case_when(
    stringr::str_detect(
      sample, paste(jasper_table$sample, collapse = "|")
    ) ~ "worker",
    stringr::str_detect(
      sample, paste(amel_manfredini_table$sample, collapse = "|")
    ) ~ "queen",
    stringr::str_detect(
      sample, paste(liberti_table$sample, collapse = "|")
    ) ~ "queen",
    stringr::str_detect(
      sample, paste(christen_table$sample, collapse = "|")
    ) ~ "worker"
  )) %>%
  dplyr::mutate(stage = "adult") %>%
  dplyr::mutate(species = "amel")
```

## _Bombus terrestris_
```{r}
bter_nachrs <- c(
  "LOC100643274", "LOC100643282", "LOC100645032", "LOC100646787",
  "LOC100647301", "LOC100647350", "LOC100647624", "LOC100648987",
  "LOC100649515", "LOC100649612", "LOC100649796"
)

# "LOC100645032" has low expression
bter_counts_nachrs <- bter_counts %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "ens_gene") %>%
  tidyr::gather(key = "sample", value = "norm_count", -ens_gene) %>%
  dplyr::mutate_if(is.numeric, round, digits = 4) %>%
  dplyr::filter(ens_gene %in% bter_nachrs) %>%
  dplyr::filter(ens_gene != "LOC100645032") %>%
  dplyr::mutate(subunit = case_when(
    ens_gene == "LOC100647624" ~ "alpha1",
    ens_gene == "LOC100647301" ~ "alpha2",
    ens_gene == "LOC100647350" ~ "alpha3",
    ens_gene == "LOC100648987" ~ "alpha4e5",
    ens_gene == "LOC100649515" ~ "alpha5",
    ens_gene == "LOC100643274" ~ "alpha6",
    ens_gene == "LOC100649796" ~ "alpha7",
    ens_gene == "LOC100643282" ~ "alpha8",
    ens_gene == "LOC100649612" ~ "beta1",
    ens_gene == "LOC100646787" ~ "beta2"
  )) %>%
  dplyr::mutate(study = case_when(
    stringr::str_detect(
      sample, paste(colgan_table$sample, collapse = "|")
    ) ~ "colgan",
    stringr::str_detect(
      sample, paste(harrison_table$sample, collapse = "|")
    ) ~ "harrison"
  )) %>%
  dplyr::mutate(tissue = case_when(
    stringr::str_detect(
      sample, paste(colgan_table$sample, collapse = "|")
    ) ~ "head",
    stringr::str_detect(
      sample, paste(harrison_table$sample, collapse = "|")
    ) ~ "whole_body"
  )) %>%
  dplyr::mutate(caste = case_when(
    grepl("queen", sample) ~ "queen",
    grepl("worker", sample) ~ "worker"
  )) %>%
  dplyr::mutate(stage = case_when(
    stringr::str_detect(
      sample, paste(colgan_table$sample, collapse = "|")
    ) ~ "adult",
    grepl("adult", sample) ~ "adult",
    grepl("larva", sample) ~ "larva",
    grepl("pupa", sample) ~ "pupa"
  )) %>%
  dplyr::mutate(species = "bter")
```

# Combine data frames of normalised counts
```{r}
amel_bter_counts_nachrs <- dplyr::bind_rows(
  amel_counts_nachrs, bter_counts_nachrs
)

# Recode subunit "alpha4" in Bombus terrestris
amel_bter_counts_nachrs$subunit <- dplyr::recode(
  amel_bter_counts_nachrs$subunit,
  "alpha4e5" = "alpha4"
)

write.csv(amel_bter_counts_nachrs,
  file = here::here(
    "results", "2020-07-28-gene_expression",
    "amel_bter_norm_counts_nachrs.csv"
  ),
  row.names = FALSE
)
```

# Means of sum of counts
```{r}
# For each sample, sum the normalised counts of all subunits
amel_bter_sum_nachrs <- amel_bter_counts_nachrs %>%
  dplyr::group_by(species, study, tissue, stage, caste, sample) %>%
  dplyr::summarise(count_sum = sum(norm_count)) %>%
  dplyr::mutate_if(is.numeric, round, digits = 4)

write.csv(amel_bter_sum_nachrs,
  file = here::here(
    "results", "2020-07-28-gene_expression",
    "amel_bter_sum_norm_counts_nachrs.csv"
  ),
  row.names = FALSE
)

# For each condition, calculate the mean of the sum of counts
amel_bter_mean_nachrs <- amel_bter_sum_nachrs %>%
  dplyr::group_by(species, tissue, stage, caste) %>%
  dplyr::summarise(
    mean_sum = mean(count_sum),
    sd = sd(count_sum)
  ) %>%
  dplyr::mutate_if(is.numeric, round, digits = 4)

# Create a function to add a new variable for plotting
add_condition <- function(df) {
  df <- tidyr::unite(df,
    col = "condition", c("caste", "tissue", "stage"),
    remove = FALSE
  )
  df <- dplyr::mutate(df,
    condition = ifelse(species == "amel" & !tissue == "brain",
      gsub(c("worker_|_adult"), "", condition), condition
    )
  )
  df <- dplyr::mutate(df,
    condition = ifelse(species == "amel" & tissue == "brain",
      gsub(c("_adult"), "", condition), condition
    )
  )
  df <- dplyr::mutate(df,
    condition = ifelse(species == "bter" & tissue == "head",
      gsub(c("_adult"), "", condition), condition
    )
  )
  df <- dplyr::mutate(df,
    condition = ifelse(species == "bter",
      gsub(c("whole_body_"), "", condition), condition
    )
  )
  df <- dplyr::relocate(df, condition, .after = last_col())
  return(df)
}

amel_bter_mean_nachrs <- add_condition(amel_bter_mean_nachrs)

write.csv(amel_bter_mean_nachrs,
  file = here::here(
    "results", "2020-07-28-gene_expression",
    "amel_bter_mean_sum_norm_counts_nachrs.csv"
  ),
  row.names = FALSE
)
```

# Subunit expression proportions
```{r}
amel_bter_proportions <- amel_bter_counts_nachrs %>%
  dplyr::group_by(species, study, caste, tissue, stage, sample) %>%
  dplyr::mutate(proportion = norm_count / sum(norm_count)) %>%
  dplyr::mutate_if(is.numeric, round, digits = 4)

amel_bter_proportions <- add_condition(amel_bter_proportions)

write.csv(amel_bter_proportions,
  file = here::here(
    "results", "2020-07-28-gene_expression",
    "amel_bter_proportions_nachrs.csv"
  ),
  row.names = FALSE
)
```

# Medians of subunit proportions
Create new `DESeqDataSet` objects with the samples from brains used 
in the correlation tests between species.

Worker caste data sets:  
Jasper et al. 2015 (amel)  
Porath et al. 2019 (bter)  

Queen caste data sets:   
Manfredini et al. 2015 (amel)  
Manfredini et al. 2017 (bter)  

# Read tables of samples and covariates
## _Apis mellifera_
```{r}
# Jasper et al. 2015
# Select the worker "brain" samples
jasper_brain_table <- jasper_table %>%
  dplyr::filter(tissue == "brain")

jasper_brain_files <- jasper_files[grep("brain", jasper_files)]

# Combine input files and information about the samples
amel_brain_files <- c(jasper_brain_files, amel_manfredini_files)
amel_brain_table <- dplyr::bind_rows(
  jasper_brain_table, amel_manfredini_table
) %>%
  dplyr::select(sample, caste, tissue, study, species)
```

## _Bombus terrestris_
```{r}
# Workers
# Porath et al. 2019
# Set sample identifiers using the names of the kallisto output directories
porath_ids <- dir(here::here(
  "2019-porath_worker_brain", "2020-07-14-kallisto", "results"
))

# Read metadata table
porath_table <- read.csv(
  here::here(
    "bter_metadata",
    "2019-porath_worker_brains_metadata.csv"
  ),
  header = TRUE,
  stringsAsFactors = TRUE
)

porath_files <- here::here(
  "2019-porath_worker_brain", "2020-07-14-kallisto", "results",
  porath_table$sample,
  "abundance.h5"
)

names(porath_files) <- porath_table$sample

# Check that sample names match
all(porath_ids %in% porath_table$sample)

# Check that all files exist
all(file.exists(porath_files))

# Queens
# Manfredini et al. 2017
# Set sample identifiers using the names of the kallisto output directories
bter_manfredini_ids <- dir(here::here(
  "2017-manfredini_queen_brain", "2020-08-08-kallisto", "results"
))

# Read metadata table
bter_manfredini_table <- read.csv(
  here::here("bter_metadata", "2017-manfredini_queen_brain_metadata.csv"),
  header = TRUE,
  stringsAsFactors = TRUE
)

# Read .h5 files in
bter_manfredini_files <- here::here(
  "2017-manfredini_queen_brain", "2020-08-08-kallisto", "results",
  bter_manfredini_table$sample,
  "abundance.h5"
)

# Assign names to files
names(bter_manfredini_files) <- bter_manfredini_table$sample

# Check that sample names match
all(bter_manfredini_ids %in% bter_manfredini_table$sample)

# Check that all files exist
all(file.exists(bter_manfredini_files))

# Combine input files and information about the samples
bter_brain_files <- c(porath_files, bter_manfredini_files)
bter_brain_table <- dplyr::bind_rows(
  porath_table, bter_manfredini_table
)
```

# Import `kallisto` quantifications using `tximport`
```{r}
# Apis mellifera
amel_brain_txi <- tximport::tximport(amel_brain_files,
  type = "kallisto",
  tx2gene = amel_tx2gene,
  txOut = FALSE
)

# Bombus terrestris
bter_brain_txi <- tximport::tximport(bter_brain_files,
  type = "kallisto",
  tx2gene = bter_tx2gene,
  txOut = FALSE
)
```

# Create `DESeqDataSet` objects
```{r}
# Apis mellifera
amel_brain_dds <- DESeq2::DESeqDataSetFromTximport(amel_brain_txi,
  colData = amel_brain_table,
  design = ~caste
)

# Estimate the size factors
amel_brain_dds <- DESeq2::estimateSizeFactors(amel_brain_dds)
# Filtering
keep <- rowSums(DESeq2::counts(amel_brain_dds) >= 10) >= 3
dds <- amel_brain_dds[keep, ]

# Bombus terrestris
bter_brain_dds <- DESeq2::DESeqDataSetFromTximport(bter_brain_txi,
  colData = bter_brain_table,
  design = ~caste
)

# Estimate the size factors
bter_brain_dds <- DESeq2::estimateSizeFactors(bter_brain_dds)
# Filtering
keep <- rowSums(DESeq2::counts(bter_brain_dds) >= 10) >= 3
dds <- bter_brain_dds[keep, ]
```

# Normalise the counts using `DESeq2`'s median-of-ratios method
```{r}
amel_brain_counts <- DESeq2::counts(amel_brain_dds, normalized = TRUE)
bter_brain_counts <- DESeq2::counts(bter_brain_dds, normalized = TRUE)

# amel_brain_vsd <- DESeq2::vst(amel_brain_dds, blind = FALSE)
# DESeq2::plotPCA(amel_brain_vsd, intgroup = "caste")
# High within-group variability in queen samples

# bter_brain_vsd <- DESeq2::vst(bter_brain_dds, blind = FALSE)
# DESeq2::plotPCA(bter_brain_vsd, intgroup = "caste")
# One outlier in worker samples, high within-group variability in queen samples
```

# Create data frames of normalised counts 
## Apis mellifera
```{r}
amel_nachrs <- c(
  "GB42850", "GB42644", "GB47845", "GB43275", "GB43064", "GB43416",
  "GB53053", "GB40923", "GB53427", "GB53055", "GB53428"
)

amel_brain_counts_nachrs <- amel_brain_counts %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "ens_gene") %>%
  tidyr::gather(key = "sample", value = "norm_count", -ens_gene) %>%
  dplyr::mutate_if(is.numeric, round, digits = 4) %>%
  dplyr::filter(ens_gene %in% amel_nachrs) %>%
  dplyr::mutate(subunit = case_when(
    ens_gene == "GB42850" ~ "alpha1",
    ens_gene == "GB42644" ~ "alpha2",
    ens_gene == "GB47845" ~ "alpha3",
    ens_gene == "GB43275" ~ "alpha4",
    ens_gene == "GB43064" ~ "alpha5",
    ens_gene == "GB43416" ~ "alpha6",
    ens_gene == "GB53053" ~ "alpha7",
    ens_gene == "GB40923" ~ "alpha8",
    ens_gene == "GB53427" ~ "alpha9",
    ens_gene == "GB53055" ~ "beta1",
    ens_gene == "GB53428" ~ "beta2"
  )) %>%
  dplyr::mutate(study = case_when(
    stringr::str_detect(
      sample, paste(jasper_table$sample, collapse = "|")
    ) ~ "jasper",
    stringr::str_detect(
      sample, paste(amel_manfredini_table$sample, collapse = "|")
    ) ~ "manfredini"
  )) %>%
  dplyr::mutate(caste = case_when(
    stringr::str_detect(
      sample, paste(jasper_table$sample, collapse = "|")
    ) ~ "worker",
    stringr::str_detect(
      sample, paste(amel_manfredini_table$sample, collapse = "|")
    ) ~ "queen"
  )) %>%
  dplyr::mutate(tissue = "brain") %>%
  dplyr::mutate(species = "amel")
```

## _Bombus terrestris_
```{r}
bter_nachrs <- c(
  "LOC100643274", "LOC100643282", "LOC100645032", "LOC100646787",
  "LOC100647301", "LOC100647350", "LOC100647624", "LOC100648987",
  "LOC100649515", "LOC100649612", "LOC100649796"
)

# "LOC100645032" has low expression
bter_brain_counts_nachrs <- bter_brain_counts %>%
  as.data.frame() %>%
  tibble::rownames_to_column(var = "ens_gene") %>%
  tidyr::gather(key = "sample", value = "norm_count", -ens_gene) %>%
  dplyr::mutate_if(is.numeric, round, digits = 4) %>%
  dplyr::filter(ens_gene %in% bter_nachrs) %>%
  dplyr::filter(ens_gene != "LOC100645032") %>%
  dplyr::mutate(subunit = case_when(
    ens_gene == "LOC100647624" ~ "alpha1",
    ens_gene == "LOC100647301" ~ "alpha2",
    ens_gene == "LOC100647350" ~ "alpha3",
    ens_gene == "LOC100648987" ~ "alpha4e5",
    ens_gene == "LOC100649515" ~ "alpha5",
    ens_gene == "LOC100643274" ~ "alpha6",
    ens_gene == "LOC100649796" ~ "alpha7",
    ens_gene == "LOC100643282" ~ "alpha8",
    ens_gene == "LOC100649612" ~ "beta1",
    ens_gene == "LOC100646787" ~ "beta2"
  )) %>%
  dplyr::mutate(study = case_when(
    stringr::str_detect(
      sample, paste(porath_table$sample, collapse = "|")
    ) ~ "porath",
    stringr::str_detect(
      sample, paste(bter_manfredini_table$sample, collapse = "|")
    ) ~ "manfredini"
  )) %>%
  dplyr::mutate(caste = case_when(
    stringr::str_detect(
      sample, paste(porath_table$sample, collapse = "|")
    ) ~ "worker",
    stringr::str_detect(
      sample, paste(bter_manfredini_table$sample, collapse = "|")
    ) ~ "queen"
  )) %>%
  dplyr::mutate(tissue = "brain") %>%
  dplyr::mutate(species = "bter")
```

# Combine data frames of normalised counts
```{r}
amel_bter_brain_counts_nachrs <- dplyr::bind_rows(
  amel_brain_counts_nachrs, bter_brain_counts_nachrs
)

# Recode subunit "alpha4" in Bombus terrestris
amel_bter_brain_counts_nachrs$subunit <- dplyr::recode(
  amel_bter_brain_counts_nachrs$subunit,
  "alpha4e5" = "alpha4"
)
```

# Compute the median expression proportions
```{r}
# Create data frames of normalised counts and calculate expression proportions
# Discard data from divergent subunits
divergent_subunits <- c("alpha9", "beta2")

amel_bter_brain_proportions <- amel_bter_brain_counts_nachrs %>%
  dplyr::group_by(sample) %>%
  dplyr::mutate(proportion = norm_count / sum(norm_count)) %>%
  dplyr::filter(!subunit %in% divergent_subunits) %>% # Remove divergent subunits
  dplyr::mutate_if(is.numeric, round, digits = 4)

median_proportions <- amel_bter_brain_proportions %>%
  dplyr::ungroup() %>% # Remove grouping variable previously created
  dplyr::select(species, caste, subunit, proportion) %>%
  dplyr::group_by(species, caste, subunit) %>%
  dplyr::summarise_at(vars(-group_cols()), ~ median(.)) %>%
  dplyr::rename(median_proportion = proportion) %>%
  dplyr::mutate_if(is.numeric, round, digits = 4)

# Verify that the median values match the expected results
# amel_bter_brain_proportions %>%
#   dplyr::filter(species == "amel" & caste == "queen" & subunit == "alpha1") %>%
#   dplyr::pull(var = proportion)
# median(c(0.0199, 0.0149, 0.0239, 0.0269))

# Change to wide format
median_proportions_wide <- median_proportions %>%
  tidyr::spread(key = species, value = median_proportion)

write.csv(median_proportions_wide,
  file = here::here(
    "results", "2020-07-28-gene_expression",
    "amel_bter_brain_median_proportions_nachrs_wide.csv"
  ),
  row.names = FALSE
)
```
